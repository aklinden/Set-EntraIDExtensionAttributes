# `Set-EntraIDExtensionAttributes.ps1`

Populate EntraID computer `extensionAttributes` for `Office`, `Department`, and
`DeviceType` based on a device's location in the OU tree. Because Autopilot
provisions devices differently, the script also marks devices as hybrid-joined
or cloud-only in an extension attribute.

## TL;DR

Enumerates on-prem AD computers and derives Office/Department/DeviceType from
the OU path. When values differ, the script updates `extensionAttribute1`–
`extensionAttribute4` in Entra ID.

## Prerequisites

Ensure the following requirements are met before running the script:

- `PowerShell` 5.1 or later
- Modules:
  - `Microsoft.Graph.Authentication`
  - `Microsoft.Graph.Identity.DirectoryManagement`
  - `ActiveDirectory` (RSAT)
- Authentication & permissions:
  - Graph scopes used by the script:
    - Read devices: `Device.Read.All` (used by `Get-MgDevice` / `Invoke-MgGraphRequest`)
    - Update devices: `Device.ReadWrite.All` (used by `Update-MgDevice`)
  - For automation with app-only auth, ensure the app has
    `Device.ReadWrite.All` application permission and that admin consent has
    been granted.
  - The account running the script must be able to read on-prem AD computer
    objects (for example via `Get-ADComputer`).

## Warning

This script, as distributed, enumerates Active Directory computers with
`Get-ADComputer -Filter *` and will therefore run against all computer objects
in the domain if you run it without modification. Scope the query to your
environment before running in production.

For example:

- Replace `-Filter *` with a more restrictive filter or add `-SearchBase` to limit an OU.
- Call `Get-Extensionattributes` or `Compare-EntraIDExtensionAttributes` directly for a named host or a small list instead of running the top-level loop.

Be careful when running this in large environments — test in a limited scope first.

## Usage examples

- Run against all on-prem computers (default behavior):
```powershell
pwsh .\Set-EntraIDExtensionAttributes.ps1
```

- Run helper functions for a single computer (dot-source the script to load functions into your session):
```powershell
. .\Set-EntraIDExtensionAttributes.ps1
Get-Extensionattributes -computername "COMPUTER01"
```

## What the script updates

- `extensionAttribute1` <- Office
- `extensionAttribute2` <- Department
- `extensionAttribute3` <- Machinetype
- `extensionAttribute4` <- Infrastructure

Only attributes that differ are updated. The script builds a minimal payload that
contains only the changed attributes.

## Functions

- `Get-Extensionattributes`
  - Uses regex patterns to derive values for `Office`, `Department`, and
    `DeviceType` from an Active Directory computer object's `distinguishedName`
    property.
- `Compare-EntraIDExtensionAttributes`
  - Compares the `extensionAttributes` in Entra ID with those generated by
    `Get-Extensionattributes`. If discrepancies are found, the EntraID object's
    attributes are updated.

## License & Contact

See the `LICENSE` file for license details.




